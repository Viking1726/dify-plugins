## mysql-query

**Author:** viking
**Version:** 0.0.1
**Type:** tool

# MySQL查询插件（优化版）

为Dify工作流提供MySQL数据库查询功能，支持分页返回结果，具有连接池优化和更好的错误处理。

## 功能特点

- 执行SQL SELECT查询语句（出于安全考虑，仅支持SELECT查询）
- 支持分页查询，控制返回结果数量
- 返回结果总数，便于前端分页展示
- 连接池优化，提高性能和减少数据库连接开销
- 增强的错误处理和详细的错误信息
- 适用于多种数据查询和报表生成场景

## 性能优化

- **连接池管理**：使用SQLAlchemy连接池，减少频繁创建和关闭连接的开销
- **超时配置**：添加连接超时和读取超时设置，防止长时间等待
- **连接复用**：缓存数据库引擎实例，减少资源消耗
- **SQL优化选项**：支持`SQL_CALC_FOUND_ROWS`和`FOUND_ROWS()`优化，可减少查询次数
- **安全限制**：限制每页最大记录数为100，防止过大的查询结果导致性能问题

## 使用说明

### 配置参数

工具节点需要配置以下参数：

- **主机地址**：MySQL服务器主机地址
- **端口**：MySQL服务器端口（通常为3306）
- **用户名**：MySQL连接用户名
- **密码**：MySQL连接密码
- **数据库名**：要查询的数据库名
- **SQL查询语句**：要执行的SQL SELECT查询，使用标准SQL语法
- **页码**（可选）：当前页码，默认为1
- **每页数量**（可选）：每页返回的记录数，默认为10，最大为100

### 返回结果

工具会返回以下内容：

- **data**：查询结果数组，每个元素为一条记录
- **total**：查询结果总条数
- **page**：当前页码
- **pagesize**：每页条数
- **error**：如果查询失败，包含错误信息

### 优化查询技巧

对于需要获取总记录数的情况，你可以使用以下两种方式：

1. **标准方式**：工具会自动执行两次查询（一次COUNT，一次数据查询）
2. **优化方式**：在查询中使用`SQL_CALC_FOUND_ROWS`，例如：
   ```sql
   SELECT SQL_CALC_FOUND_ROWS * FROM users WHERE status = 'active'
   ```
   这样工具会使用`FOUND_ROWS()`函数获取总记录数，减少一次查询

### 工作流示例

1. 添加MySQL查询节点到工作流
2. 配置连接信息和查询语句
3. 使用代码节点或模板转换处理返回结果
4. 通过LLM节点生成分析报告

## 安全注意事项

- 使用只读数据库账户执行查询
- 避免在查询中包含敏感信息
- 注意SQL注入风险，谨慎处理用户输入
- 工具仅支持SELECT查询，不支持数据修改操作

## 错误处理

工具会返回详细的错误信息，常见错误包括：

- 数据库连接失败
- SQL语法错误
- 查询超时
- 权限不足

错误信息将在返回的`error`字段中提供，同时会在日志中记录详细信息。

## 依赖项

- SQLAlchemy 2.0+
- PyMySQL 1.0+

## 联系与支持

如有问题或建议，请联系：
- 邮箱：cswwinner@126.com
- GitHub：https://github.com/Viking1726/dify-mysql-query-plugin
